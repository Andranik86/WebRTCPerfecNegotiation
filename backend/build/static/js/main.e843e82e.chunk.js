(this.webpackJsonpfrontend=this.webpackJsonpfrontend||[]).push([[0],{50:function(e,t,n){},83:function(e,t,n){"use strict";n.r(t);var i=n(9),a=n.n(i),r=n(38),s=n.n(r),c=n(43),o=n(22),d=n(21),l=n(1),u=n.n(l),h=n(3),g=n(39),p=n(40),f=n(2),m=n(44),b=n(42),v=(n(50),n(41)),C=n.n(v),k=[{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"}],O="NEW",j="CONNECTED",S="DISCONNECTED",x="NEGOTIATING",w="CLOSED",T=n(0);var y=function(e){var t,n=["connectionActivity"];switch(e.connectionState){case S:n.push("disconnected"),t="Peer Disconnected";break;case x:n.push("connecting"),t="Peer Negotiating: ".concat(x);break;case j:n.push("connected"),t="Peer Connected";break;case O:t="New Peer";case w:t="Peer Closed";default:n.push("closed")}return e.makingOfferAnswer&&e.connectionState!==j&&(n.push("connecting"),t="Peer Negotiating: ".concat(e.connectionState)),Object(T.jsxs)(T.Fragment,{children:[Object(T.jsx)("div",{className:n.join(" ")}),e.negotiationFaileMessage?Object(T.jsxs)("p",{children:["Negotiation Faile Message: ",e.negotiationFaileMessage]}):null,Object(T.jsx)("p",{children:t})]})},P=function(e){Object(m.a)(n,e);var t=Object(b.a)(n);function n(e){var i;return Object(g.a)(this,n),(i=t.call(this,e)).polite=!0,i.peer=new RTCPeerConnection({}),i.transceiver=null,i.iceRestartsLimit=2,i.iceRestartsCount=0,i.iceGatheringTimeout=5e3,i.offerTimeoutValue=6e5,i.lastSdpOffer=null,i.offerTimer=null,i.socket=C()(),i.videoRef=a.a.createRef(),i.polite=e.polite,i.state={uuid:null,makingOffer:!1,offerTimeout:!1,offerComplete:!1,makingAnswer:!1,startNewConnection:!1,connectionState:w,streamableConnection:!1,recording:!1,paused:!1,logs:[]},i.negotiationNeededHandler=i.negotiationNeededHandler.bind(Object(f.a)(i)),i.iceGatheringStateChangeHandler=i.iceGatheringStateChangeHandler.bind(Object(f.a)(i)),i.iceConnectionStateChangeHandler=i.iceConnectionStateChangeHandler.bind(Object(f.a)(i)),i.iceCandidateHandler=i.iceCandidateHandler.bind(Object(f.a)(i)),i.newPeerConnectionHandler=i.newPeerConnectionHandler.bind(Object(f.a)(i)),i.startRecordHandler=i.startRecordHandler.bind(Object(f.a)(i)),i.pauseRecordingHandler=i.pauseRecordingHandler.bind(Object(f.a)(i)),i.stopRecordingHandler=i.stopRecordingHandler.bind(Object(f.a)(i)),i.log=i.log.bind(Object(f.a)(i)),i.clearLogs=i.clearLogs.bind(Object(f.a)(i)),i.captureCamera=i.captureCamera.bind(Object(f.a)(i)),i.closePeer=i.closePeer.bind(Object(f.a)(i)),i.completeIceGathering=i.completeIceGathering.bind(Object(f.a)(i)),i.newPeerConnection=i.newPeerConnection.bind(Object(f.a)(i)),i.socket.on("connect",(function(){i.log("Socket connected: ".concat(i.socket.id))})),i.socket.on("description",function(){var e=Object(h.a)(u.a.mark((function e(t){var n,a,r,s,c,o,d,l;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.uuid,a=t.description,i.log("Description Rescived: ".concat(n)),r=i.socket,s=i.peer,c="offer"===a.type&&(i.state.makingOffer||"stable"!==s.signalingState),o=!i.polite&&c,i.log("OfferCollision: ".concat(c)),!o){e.next=9;break}return e.abrupt("return");case 9:if(i.offerTimer&&(clearTimeout(i.offerTImer),i.offerTimer=null),"offer"===a.type?i.setState({makingOffer:!1,makingAnswer:!0}):i.setState({makingOffer:!1}),!c){e.next=16;break}return e.next=14,Promise.all([s.setLocalDescription({type:"rollback"}),s.setRemoteDescription(a)]);case 14:e.next=18;break;case 16:return e.next=18,s.setRemoteDescription(a);case 18:if(i.log("Remote Description Added: ".concat(a.type)),"offer"!==a.type){e.next=31;break}return e.next=22,s.createAnswer();case 22:return d=e.sent,l=i.completeIceGathering(),i.log("Trying to Add Local Description and find ice candidates"),e.next=27,Promise.all([l,s.setLocalDescription(d)]);case 27:i.log("Local Description Added: Answer"),i.setState({makingAnswer:!1}),r.emit("description",{uuid:n,description:s.localDescription}),i.log("Answer Sended");case 31:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),i}return Object(p.a)(n,[{key:"componentDidMount",value:function(){var e=Object(h.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.log("ComponentDidMount"),this.setState({startNewConnection:!0});case 2:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"componentDidUpdate",value:function(){var e=Object(h.a)(u.a.mark((function e(t,n){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!0!==this.state.startNewConnection){e.next=4;break}return this.setState({startNewConnection:!1}),e.next=4,this.newPeerConnection();case 4:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"completeIceGathering",value:function(){var e=Object(h.a)(u.a.mark((function e(t){var n,i,a,r,s,c,o,d=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.peer,i=this.iceGatheringTimeout,a=H(),r=H(),s=H(),c=function e(t){if(s.res(),"complete"===n.iceGatheringState)return n.removeEventListener("icegatheringstatechange",e),d.log("\ngathering state completed"),a.res()},o=function e(t){var i=t.candidate;if(s.res(),!i)return n.removeEventListener("icecandidate",e),d.log("end-of-candidates received"),r.res()},n.addEventListener("icegatheringstatechange",c),n.addEventListener("icecandidate",o),setTimeout((function(){s.resolved||(s.rej(),n.removeEventListener("icegatheringstatechange",c),n.removeEventListener("icecandidate",o))}),null!==t&&void 0!==t?t:i),e.prev=10,e.next=13,s.promise;case 13:return e.next=15,Promise.all([a.promise,r.promise]);case 15:this.log("ICE GATHERING PERFORMED"),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(10),this.log("NO ICE GATHERING PERFORMED: Timeout Occured");case 21:return e.prev=21,this.log("ICE GATHERING COMPLETED\n"),e.abrupt("return");case 25:case"end":return e.stop()}}),e,this,[[10,18,21,25]])})));return function(t){return e.apply(this,arguments)}}()},{key:"negotiationNeededHandler",value:function(){var e=Object(h.a)(u.a.mark((function e(){var t,n,i,a,r,s,c=this;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.state.uuid,this.log("negotiationNeededHandler"),n=this.peer,i=this.socket,this.transceiver){e.next=8;break}return e.next=7,n.addTransceiver("video",{direction:"inactive",streams:[]});case 7:this.transceiver=e.sent;case 8:return this.log("red"),e.prev=9,this.setState({makingOffer:!0}),this.log("blue"),a=this.completeIceGathering(),this.log("bluetooth"),e.next=16,n.createOffer();case 16:return r=e.sent,e.next=19,Promise.all([a,n.setLocalDescription(r)]);case 19:this.log("Local Description Added: Offer"),i.emit("description",{uuid:t,description:n.localDescription}),this.log("Offer Sended"),s=n.localDescription,this.lastSdpOffer=s,this.offerTimer=setTimeout((function(){"have-local-offer"===n.signalingState&&s===c.lastSdpOffer&&(c.log("Closing Connection: ".concat(t," due to SDP Offer Timeout")),n.close(),c.setState({makingOffer:!1,offerTimeout:!0}))}),this.offerTimeoutValue),e.next=31;break;case 27:e.prev=27,e.t0=e.catch(9),this.log(e.t0.message),this.setState({makingOffer:!1,negotiationFaileMessage:"Connection Failed: Blablabla"});case 31:case"end":return e.stop()}}),e,this,[[9,27]])})));return function(){return e.apply(this,arguments)}}()},{key:"iceCandidateHandler",value:function(e){e.candidate;this.log("iceCandidateHandler")}},{key:"iceGatheringStateChangeHandler",value:function(){switch(this.peer.iceGatheringState){case"new":this.log("ICE Gathering: New");break;case"gathering":this.log("ICE Gathering: Gathering");break;case"complete":this.log("ICE Gathering: Completed")}}},{key:"iceConnectionStateChangeHandler",value:function(){switch(this.log("\niceConnectionStateChangeHandler: ".concat(this.state.uuid)),this.log("STATE: ".concat(this.peer.iceConnectionState,"\n")),this.peer.iceConnectionState){case"checking":this.setState({connectionState:x,negotiationFaileMessage:"Checking ICE Candidates",streamableConnection:!1});break;case"disconnected":this.setState({connectionState:S,negotiationFaileMessage:"Temporarly Disconnected",streamableConnection:!1});break;case"failed":this.closePeer(),this.setState({connectionState:S,negotiationFaileMessage:"Connection Failed: Closing connection",streamableConnection:!1});break;case"closed":this.transceiver=null,this.peer=null,this.setState({uuid:null,connectionState:w,negotiationFaileMessage:"Connection Closed",streamableConnection:!1});break;case"connected":case"completed":this.setState({connectionState:j,offerTimeout:!1,negotiationFaileMessage:null,streamableConnection:!0});break;default:this.setState({streamableConnection:!1})}}},{key:"newPeerConnection",value:function(){var e=this;this.socket.emit("getUUID",function(){var t=Object(h.a)(u.a.mark((function t(n){var i,a,r,s,c;return u.a.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=n.data,n.success){t.next=3;break}return t.abrupt("return");case 3:return a=i.uuid,e.log("GetUUID: ".concat(a)),e.setState({uuid:a}),e.peer=new RTCPeerConnection({iceServers:k}),e.peer.addEventListener("negotiationneeded",e.negotiationNeededHandler),e.peer.addEventListener("icegatheringstatechange",e.iceGatheringStateChangeHandler),e.peer.addEventListener("iceconnectionstatechange",e.iceConnectionStateChangeHandler),e.peer.addEventListener("icecandidate",e.iceCandidateHandler),t.prev=11,t.next=14,e.captureCamera();case 14:return e.mediaStream=t.sent,e.setState({recording:!1,paused:!1}),r=e.mediaStream.getVideoTracks(),s=Object(d.a)(r,1),c=s[0],t.next=19,e.peer.addTransceiver(c,{direction:"inactive",streams:[e.mediaStream]});case 19:e.transceiver=t.sent,t.next=26;break;case 22:t.prev=22,t.t0=t.catch(11),e.log(t.t0.message),e.closePeer();case 26:case"end":return t.stop()}}),t,null,[[11,22]])})));return function(e){return t.apply(this,arguments)}}())}},{key:"log",value:function(e){e+="",console.log(e),this.setState((function(t){return Object(o.a)(Object(o.a)({},t),{},{logs:[].concat(Object(c.a)(t.logs),[e.trim()])})}))}},{key:"clearLogs",value:function(){this.setState({logs:[]})}},{key:"closePeer",value:function(){if(this.log("closePeer"),this.peer&&"closed"!==this.peer.iceConnectionState)return this.peer.close(),this.mediaStream&&(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null),void this.socket.emit("closePeer",{uuid:this.state.uuid})}},{key:"newPeerConnectionHandler",value:function(){this.closePeer(),this.setState({uuid:null,makingOffer:!1,offerTimeout:!1,offerComplete:!1,makingAnswer:!1,startNewConnection:!0,connectionState:w,streamableConnection:!1})}},{key:"captureCamera",value:function(){var e=Object(h.a)(u.a.mark((function e(){var t,n;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.videoRef.current,e.next=3,navigator.mediaDevices.getUserMedia({video:{facingMode:"user"},audio:!1});case 3:return n=e.sent,t.srcObject=n,e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"startRecordHandler",value:function(){var e=Object(h.a)(u.a.mark((function e(){var t,n,i;return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.state.streamableConnection||!(!this.state.recording||this.state.recording&&this.state.paused)){e.next=16;break}if(this.peer&&this.transceiver&&"stopped"!==this.transceiver.direction){e.next=3;break}return e.abrupt("return");case 3:if(this.transceiver){e.next=7;break}return e.next=6,this.peer.addTransceiver("video",{direction:"inactive",streams:[]});case 6:this.transceiver=e.sent;case 7:if(this.transceiver.sender.track&&"ended"!==this.transceiver.sender.track.readyState){e.next=13;break}return e.next=10,this.captureCamera();case 10:this.mediaStream=e.sent,t=this.mediaStream.getVideoTracks(),n=Object(d.a)(t,1),i=n[0],this.transceiver.sender.replaceTrack(i);case 13:this.transceiver.direction="sendonly",this.log("\nStart Recording: ".concat(this.state.uuid)),this.setState({recording:!0,paused:!1});case 16:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"pauseRecordingHandler",value:function(){var e=Object(h.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.state.streamableConnection||!this.state.recording||this.state.paused){e.next=6;break}if(this.peer&&this.transceiver&&"stopped"!==this.transceiver.direction){e.next=3;break}return e.abrupt("return");case 3:this.log("\nPause Recording: ".concat(this.state.uuid)),this.transceiver.direction="inactive",this.setState({recording:!0,paused:!0});case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"stopRecordingHandler",value:function(){var e=Object(h.a)(u.a.mark((function e(){return u.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.state.streamableConnection||!this.state.recording){e.next=6;break}if(this.peer&&this.transceiver&&"stopped"!==this.transceiver.direction){e.next=3;break}return e.abrupt("return");case 3:this.log("\nStop Recording: ".concat(this.state.uuid));try{this.transceiver.direction="inactive",this.transceiver.stop(),this.transceiver=null}catch(t){this.log(t.message)}this.setState({recording:!1,paused:!1});case 6:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"render",value:function(){return Object(T.jsxs)("div",{className:"App",children:[Object(T.jsxs)("div",{children:[Object(T.jsx)(y,{connectionState:this.state.connectionState,makingOfferAnswer:this.state.makingOffer||this.state.makingAnswer,negotiationFaileMessage:this.state.negotiationFaileMessage}),Object(T.jsx)("button",{onClick:this.newPeerConnectionHandler,children:"New Peer Connection"}),Object(T.jsx)("button",{onClick:this.startRecordHandler,className:this.state.streamableConnection&&(!this.state.recording||this.state.recording&&this.state.paused)?"success":"error",children:"Start Recording"}),Object(T.jsx)("button",{onClick:this.pauseRecordingHandler,className:this.state.streamableConnection&&this.state.recording&&!this.state.paused?"success":"error",children:"Pause Recording"}),Object(T.jsx)("button",{onClick:this.stopRecordingHandler,className:this.state.streamableConnection&&this.state.recording?"success":"error",children:"Stop Recording"}),Object(T.jsx)("video",{autoPlay:!0,muted:!0,ref:this.videoRef})]}),Object(T.jsxs)("div",{children:[Object(T.jsx)("button",{onClick:this.clearLogs,children:"Clear Logs"}),Object(T.jsx)("p",{children:":logs:"}),this.state.logs.map((function(e,t){return Object(T.jsxs)("p",{children:[t,": ",e]},t)}))]})]})}}]),n}(a.a.Component);function H(){var e={res:null,rej:null,promise:null,finished:!1,resolved:!1,rejected:!1};return e.promise=new Promise((function(t,n){e.res=function(){e.finished||(e.finished=!0,e.resolved=!0,t())},e.rej=function(){e.finished||(e.finished=!0,e.rejected=!0,n())}})),e}var R=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,84)).then((function(t){var n=t.getCLS,i=t.getFID,a=t.getFCP,r=t.getLCP,s=t.getTTFB;n(e),i(e),a(e),r(e),s(e)}))};s.a.render(Object(T.jsx)(a.a.StrictMode,{children:Object(T.jsx)(P,{polite:!0})}),document.getElementById("root")),R()}},[[83,1,2]]]);
//# sourceMappingURL=main.e843e82e.chunk.js.map